<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Attendance Report - Enpower Skill Lab</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="student-dashboard.css">
    <!-- Header JS -->
    <script src="header.js"></script>
    <link rel="stylesheet" href="attendance.css">

    <style>
        /* Prevent FOUC - hide containers until loaded */
        #sidebar-container:empty,
        #header-container:empty {
            opacity: 0;
            visibility: hidden;
        }

        #sidebar-container.loaded,
        #header-container.loaded {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Include Header Component -->
            <div id="header-container"></div>
            <!-- Report Card -->
            <div class="report-card">
                <div class="report-header">
                    <div class="page-header">
                        <h1 class="page-title">My Attendance Report</h1>
                        <p class="page-subtitle">View your complete attendance history and statistics</p>
                    </div>
                    <div class="report-filters">
                        <select id="monthFilter" onchange="renderSessions()">
                            <option value="all">All Months</option>
                        </select>
                        <select id="yearFilter">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-dot present"></span>
                        <span>P - Present</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot absent"></span>
                        <span>A - Absent</span>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-circle-container">
                        <div class="stat-circle overall">
                            <div class="stat-percentage" id="overallPercent">0%</div>
                            <div class="stat-label">Overall</div>
                        </div>
                    </div>

                    <div class="stat-box">
                        <div class="stat-box-label present">PRESENTS</div>
                        <div class="stat-box-value present" id="presentCount">0</div>
                        <div class="stat-box-subtitle">Total Sessions</div>
                    </div>

                    <div class="stat-box absent-box">
                        <div class="stat-box-label absent">ABSENTS</div>
                        <div class="stat-box-value absent" id="absentCount">0</div>
                        <div class="stat-box-subtitle">Total Sessions</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Year Progress</span>
                        <span id="progressText">0/48 Sessions</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="session-view-header">Session-wise Attendance</div>
                <div id="sessionsContainer"></div>
            </div>
            
            
        </main>
    </div>

    <script>
        // Load Sidebar and Header Components
        Promise.all([
            fetch('sidebar.html').then(response => response.text()),
            fetch('header.html').then(response => response.text())
        ]).then(([sidebarHTML, headerHTML]) => {
            // Insert both components
            document.getElementById('sidebar-container').innerHTML = sidebarHTML;
            document.getElementById('header-container').innerHTML = headerHTML;

            // Use setTimeout to ensure DOM has parsed the inserted HTML
            setTimeout(() => {
                initializeSidebar();
                // Call header initialization directly instead of relying on DOMContentLoaded
                if (typeof initializeHeader === 'function') {
                    initializeHeader();
                }

                // Mark containers as loaded to make them visible with smooth transition
                document.getElementById('sidebar-container').classList.add('loaded');
                document.getElementById('header-container').classList.add('loaded');
            }, 0);
        });

        function initializeSidebar() {
            const menuToggle = document.getElementById('menuToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function toggleSidebar() {
                if (window.innerWidth >= 1024) {
                    sidebar.classList.toggle('collapsed');
                } else {
                    sidebar.classList.add('active');
                    sidebarOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeSidebarFunc() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            menuToggle.addEventListener('click', toggleSidebar);
            closeSidebar.addEventListener('click', closeSidebarFunc);
            sidebarOverlay.addEventListener('click', closeSidebarFunc);

            const sidebarLinks = sidebar.querySelectorAll('a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        closeSidebarFunc();
                    }
                });
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    closeSidebarFunc();
                } else {
                    sidebar.classList.remove('collapsed');
                }
            });

            // Set active link
            setActiveLink();
        }

        function setActiveLink() {
            const currentPage = window.location.pathname.split('/').pop();
            const navLinks = {
                'student-dashboard.html': 'nav-dashboard',
                'attendance.html': 'nav-attendance',
                'lms.html': 'nav-lms',
                'leaderboard.html': 'nav-leaderboard',
                'assessment.html': 'nav-assessment',
                'reports.html': 'nav-reports',
                'badges.html': 'nav-badges',
                'event-calendar.html': 'nav-event-calendar',
                'newsletter.html': 'nav-newsletter',
                'announcements.html': 'nav-announcements'
            };

            const sidebar = document.getElementById('sidebar');
            const sidebarLinks = sidebar.querySelectorAll('a');
            sidebarLinks.forEach(link => link.classList.remove('active'));

            if (navLinks[currentPage]) {
                const activeLink = document.getElementById(navLinks[currentPage]);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            }
        }

        // Attendance Report Functionality
        const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        // Populate month dropdown
        const monthDropdown = document.getElementById("monthFilter");
        months.forEach((m, i) => {
            monthDropdown.innerHTML += `<option value="${i}">${m}</option>`;
        });

        // Generate 48 sessions with random attendance (Replace with actual data)
        const TOTAL_SESSIONS = 48;
        let attendanceData = {};

        for (let i = 1; i <= TOTAL_SESSIONS; i++) {
            attendanceData[i] = Math.random() > 0.3 ? "P" : "A"; // 70% present rate
        }

        function updateStats() {
            let presentCount = 0;
            let absentCount = 0;

            for (let i = 1; i <= TOTAL_SESSIONS; i++) {
                if (attendanceData[i] === "P") presentCount++;
                else absentCount++;
            }

            const percentage = Math.round((presentCount / TOTAL_SESSIONS) * 100);

            document.getElementById('overallPercent').textContent = percentage + '%';
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('progressText').textContent = presentCount + '/' + TOTAL_SESSIONS + ' Sessions';
            document.getElementById('progressBar').style.width = percentage + '%';

            // Update circle color based on percentage
            const circle = document.querySelector('.stat-circle.overall');
            const percentText = document.getElementById('overallPercent');

            if (percentage >= 75) {
                circle.style.borderColor = '#e9d5f0';
                circle.style.background = 'linear-gradient(135deg, #ffffff 0%, #f5ebf7 100%)';
            } else if (percentage >= 50) {
                circle.style.borderColor = '#c4a3d1';
                circle.style.background = 'linear-gradient(135deg, #f5ebf7 0%, #e9d5f0 100%)';
                percentText.style.background = 'linear-gradient(135deg, #A67DB1 0%, #6b277e 100%)';
                percentText.style.webkitBackgroundClip = 'text';
                percentText.style.webkitTextFillColor = 'transparent';
                percentText.style.backgroundClip = 'text';
            } else {
                circle.style.borderColor = '#fecaca';
                circle.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)';
                percentText.style.background = '#991b1b';
                percentText.style.webkitBackgroundClip = 'text';
                percentText.style.webkitTextFillColor = 'transparent';
                percentText.style.backgroundClip = 'text';
            }
        }

        function getWeekOfMonth(sessionInMonth) {
            return `Week ${sessionInMonth}`;
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = '';
            const selectedMonth = document.getElementById('monthFilter').value;

            for (let month = 0; month < 12; month++) {
                if (selectedMonth !== "all" && selectedMonth != month) continue;

                const startSession = month * 4 + 1;
                const endSession = startSession + 3;

                const monthSection = document.createElement('div');
                monthSection.className = 'month-section';

                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.innerHTML = `
                    <span>${months[month]}</span>
                    <span class="month-range">Sessions ${startSession} - ${endSession}</span>
                `;

                const sessionsGrid = document.createElement('div');
                sessionsGrid.className = 'sessions-grid';

                for (let s = 0; s < 4; s++) {
                    const sessionNum = startSession + s;
                    const status = attendanceData[sessionNum];

                    const sessionCard = document.createElement('div');
                    sessionCard.className = `session-card ${status === 'P' ? 'present' : 'absent'}`;
                    sessionCard.innerHTML = `
                        <div class="session-number ${status === 'P' ? 'present' : 'absent'}">
                            Session ${sessionNum}
                        </div>
                        <div class="session-week">${getWeekOfMonth(s + 1)}</div>
                        <div class="session-status ${status === 'P' ? 'present' : 'absent'}">
                            ${status === 'P' ? '✓ Present' : '✗ Absent'}
                        </div>
                    `;

                    sessionsGrid.appendChild(sessionCard);
                }

                monthSection.appendChild(monthHeader);
                monthSection.appendChild(sessionsGrid);
                container.appendChild(monthSection);
            }
        }

        // Initialize
        updateStats();
        renderSessions();
    </script>
</body>

</html>
